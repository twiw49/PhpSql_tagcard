<!DOCTYPE HTML>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tag Cards | Search</title>
  <style>

  </style>
  <!-- bootstrap -->
  <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
  <!-- bootstrap-theme -->
  <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap-theme.min.css">
  <!-- font-awesome -->
  <link rel="stylesheet" href="bower_components/font-awesome/css/font-awesome.min.css">
  <!-- typeahead -->
  <link rel="stylesheet" href="bower_components/jquery-typeahead/dist/jquery.typeahead.min.css">
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <nav class="navbar navbar-inverse">
    <div class="container-fluid">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNav">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">Tag Card</a>
      </div>
      <div class="collapse navbar-collapse" id="myNav">
        <ul class="nav navbar-nav navbar-left">
          <li class="active"><a href="index.html">Search</a></li>
          <li><a href="insert.html">Insert</a></li>
        </ul>
      </div>
    </div>
  </nav>
  <div class="container">
    <div class="row">
      <div class="col-xs-12">
        <form onsubmit="return false;">
          <div class="typeahead__container">
            <div class="typeahead__field">
              <span class="typeahead__query">
                <input class="search_query" placeholder="Search" autocomplete="off">
            </span>
              <span class="typeahead__button">
                <button type="submit">
                    <i class="typeahead__search-icon"></i>
                </button>
            </span>
            </div>
          </div>
        </form>
      </div>
    </div>
    <div class="row">
      <div class="col-xs-12">
        <div id="with_tag_container">
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-xs-12">
        <div class="panel-group" id="card_container">
        </div>
      </div>
    </div>
  </div>
  <!-- jQuery -->
  <script src="bower_components/jquery/dist/jquery.min.js"></script>
  <!-- bootstrap -->
  <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
  <!-- typeahead -->
  <script src="bower_components/jquery-typeahead/dist/jquery.typeahead.min.js"></script>
  <script>
  if (!Array.prototype.has) {
    Array.prototype.has = function(val) {
      if (this.indexOf(val) !== -1) {
        return true;
      }
      return false;
    }
  };

  $(document).ready(function() {
    $('.search_query').focus();
    $.typeahead({
      input: '.search_query',
      minLength: 1,
      offset: false,
      hint: true,
      source: {
        ajax: {
          type: "POST",
          url: "sql/load_all_tags_sql.php"
        }
      },
      callback: {
        onClick: function(node, a, item, event) {
          var query = this.query;
          searchDatabase(query, [query]);
        },
        onSubmit: function(node, form, item, event) {
          var query = this.query;
          searchDatabase(query, [query]);
        }
      }
    });
  });

  function searchDatabase(q_tag, selected_tags) {
    var vars = {
      q: q_tag
    };
    $.ajax({
        type: "POST",
        url: "sql/search_sql.php",
        data: vars,
        dataType: 'json'
      })
      .done(function(data) {
        modifyData(data, selected_tags);
      })
      .fail(function(xhr) {
        console.log(xhr);
      })
  };

  function modifyData(data, selected_tags) {
    // 주요 변수들 관계
    // q_tag (single tag)
    // selected_tags (single or multiple tag(s))
    // with_tags_selected (selected_tags 모두와 동시에 태깅된 태그들)
    // with_tags_all (q_tag와 동시에 태깅된 태그들)

    // 주요 변수들 define
    var q_tag = data.tag_name;
    var selected_tags = selected_tags;
    var with_tags_selected = {};
    var with_tags_all = data.with_tags;
    var cards = data.cards;

    // cards에 property 부여하기
    for (var i = 0; i < cards.length; i++) {
      var c = cards[i];
      var c_content = c.content;
      var c_tags = c.tags;

      // 1. selected
      c.selected = false;
      for (var j = 0; j < selected_tags.length; j++) {
        if (c_tags.has(selected_tags[j])) {
          c.selected = true;
          break;
        }
      }

      // 2. with_tags_selected
      for (var j = 0; j < c_tags.length; j++) {
        if (c_tags[j] in with_tags_selected) {
          with_tags_selected[c_tags[j]] += 1;
        } else {
          with_tags_selected[c_tags[j]] = 1;
        }
      }
    }

    // with_tags_all에 property 부여하기
    for (var i = 0; i < with_tags_all.length; i++) {
      var w_tag = with_tags_all[i];

      // 1. q_tag (검색창을 통해 입력된 값)
      if (w_tag.name == q_tag) {
        w_tag.query = true;
      } else {
        w_tag.query = false;
      }

      // 2. selected_tags (체크박스를 통해 선택된 태그들의 이름을 배열에 저장한 값)
      if (selected_tags.has(w_tag.name)) {
        w_tag.selected = true;
      } else {
        w_tag.selected = false;
      }
    }

    console.log(with_tags_all);
    console.log(cards);
    console.log(with_tags_selected);

    drawTag(with_tags_all);
    drawCard(cards);
  }

  function drawTag(with_tags_all) {

  };

  function drawCard(cards) {

  };
  </script>
</body>

</html>